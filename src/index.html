<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>議事録管理アプリ</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <?!= include('css'); ?>
</head>
<body>
  <div id="app">
    <!-- トースト通知 -->
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index:1080">
      <div class="toast" :class="'text-bg-' + toast.type" ref="toastEl"
           role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-body d-flex align-items-center">
          <span>{{ toast.message }}</span>
          <button type="button" class="btn-close btn-close-white ms-auto" data-bs-dismiss="toast"></button>
        </div>
      </div>
    </div>

    <!-- ローディングオーバーレイ -->
    <div v-if="loading" class="loading-overlay">
      <div class="spinner-border" role="status" style="width:3rem;height:3rem">
        <span class="visually-hidden">読み込み中...</span>
      </div>
      <p class="mt-3" style="color:var(--text-secondary)">{{ loadingMessage }}</p>
    </div>

    <!-- 初回セットアップ画面 -->
    <div v-if="!setupDone" class="setup-card card">
      <div class="card-body py-5 px-4">
        <div class="setup-icon">
          <i class="bi bi-journal-text"></i>
        </div>
        <h3 style="font-weight:600;margin-bottom:8px">議事録管理アプリ</h3>
        <p style="color:var(--text-secondary);margin-bottom:24px">
          マイドライブに議事録管理用のデータを作成します。<br>
          保存先フォルダを選択するか、自動作成できます。
        </p>

        <!-- フォルダ選択 -->
        <div class="mb-3 text-start" style="max-width:360px;margin:0 auto">
          <label class="form-label">保存先フォルダ（任意）</label>
          <select class="form-select" v-model="setupFolderId">
            <option value="">自動作成（マイドライブ直下）</option>
            <option v-for="f in setupFolders" :key="f.id" :value="f.id">{{ f.name }}</option>
          </select>
          <button class="btn btn-sm btn-link mt-1 p-0" @click="loadSetupFolders" style="color:var(--primary)">
            <i class="bi bi-arrow-clockwise me-1"></i>フォルダ一覧を更新
          </button>
        </div>

        <button class="btn btn-primary btn-lg px-4" @click="runSetup" :disabled="setupRunning">
          <span v-if="setupRunning" class="spinner-border spinner-border-sm me-2"></span>
          {{ setupRunning ? 'セットアップ中...' : 'セットアップ開始' }}
        </button>
      </div>
    </div>

    <!-- メインレイアウト（セットアップ完了後） -->
    <div v-if="setupDone" class="app-layout">
      <!-- サイドバーオーバーレイ（モバイル） -->
      <div v-if="sidebarOpen" class="sidebar-overlay" @click="sidebarOpen = false"></div>

      <!-- サイドバー -->
      <nav class="sidebar" :class="{ show: sidebarOpen }">
        <div class="sidebar-brand">
          <h1>
            <span class="brand-icon"><i class="bi bi-journal-text"></i></span>
            議事録管理
          </h1>
        </div>
        <div class="sidebar-nav">
          <div class="nav-section">メイン</div>
          <a class="nav-item-sidebar" :class="{ active: currentPage === 'memos' }"
             @click.prevent="navigate('memos')">
            <i class="bi bi-list-check"></i> 議事録一覧
          </a>
          <a class="nav-item-sidebar" :class="{ active: currentPage === 'projects' }"
             @click.prevent="navigate('projects')">
            <i class="bi bi-folder2-open"></i> 案件管理
          </a>

          <div class="nav-section">管理</div>
          <a class="nav-item-sidebar" :class="{ active: currentPage === 'members' }"
             @click.prevent="navigate('members')">
            <i class="bi bi-people"></i> メンバー
          </a>
          <a class="nav-item-sidebar" :class="{ active: currentPage === 'templates' }"
             @click.prevent="navigate('templates')">
            <i class="bi bi-file-earmark-text"></i> テンプレート
          </a>
          <a class="nav-item-sidebar" :class="{ active: currentPage === 'settings' }"
             @click.prevent="navigate('settings')">
            <i class="bi bi-gear"></i> 設定
          </a>
        </div>
      </nav>

      <!-- メインコンテンツ -->
      <div class="main-content">
        <!-- モバイルヘッダー -->
        <div class="mobile-header">
          <button class="btn btn-sm btn-outline-secondary" @click="sidebarOpen = !sidebarOpen">
            <i class="bi bi-list"></i>
          </button>
          <span style="font-weight:600">議事録管理</span>
        </div>

        <!-- 議事録一覧画面 -->
        <div v-if="currentPage === 'memos'">
          <?!= include('page-memos'); ?>
        </div>

        <!-- 議事録編集画面 -->
        <div v-if="currentPage === 'memo-edit'">
          <?!= include('page-memo-edit'); ?>
        </div>

        <!-- 案件管理画面 -->
        <div v-if="currentPage === 'projects'">
          <?!= include('page-projects'); ?>
        </div>

        <!-- メンバー管理画面 -->
        <div v-if="currentPage === 'members'">
          <?!= include('page-members'); ?>
        </div>

        <!-- テンプレート管理画面 -->
        <div v-if="currentPage === 'templates'">
          <?!= include('page-templates'); ?>
        </div>

        <!-- 設定画面 -->
        <div v-if="currentPage === 'settings'">
          <?!= include('page-settings'); ?>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap 5 JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Vue.js 3 (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/vue@3.4.38/dist/vue.global.prod.js"></script>

  <!-- 初期データ（scriptlet埋め込みでパフォーマンス最適化） -->
  <script>
    var INITIAL_DATA = {
      isSetupDone: <?= isSetupDone ?>,
      memos: <?!= initialMemos ?>,
      templates: <?!= initialTemplates ?>,
      settings: <?!= initialSettings ?>,
      projects: <?!= initialProjects ?>,
      members: <?!= initialMembers ?>
    };
  </script>

  <?!= include('js-app'); ?>
</body>
</html>
