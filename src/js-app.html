<script>
/**
 * google.script.run のPromiseラッパー
 */
function gasRun(funcName) {
  var args = Array.prototype.slice.call(arguments, 1);
  return new Promise(function(resolve, reject) {
    var runner = google.script.run
      .withSuccessHandler(resolve)
      .withFailureHandler(reject);
    runner[funcName].apply(runner, args);
  });
}

/**
 * Vue.js アプリケーション
 */
var app = Vue.createApp({
  data: function() {
    return {
      // 状態管理
      setupDone: INITIAL_DATA.isSetupDone,
      setupRunning: false,
      setupFolderId: '',
      setupFolders: [],
      loading: false,
      loadingMessage: '',
      currentPage: 'memos',
      sidebarOpen: false,

      // トースト通知
      toast: { message: '', type: 'success' },

      // 議事録データ
      memos: INITIAL_DATA.memos || [],
      memoSearch: '',
      memoFilter: 'all',
      memoProjectFilter: 'all',
      memoDateFrom: '',
      memoDateTo: '',
      selectedMemoIds: [],
      editingMemo: {},
      deletingMemo: null,

      // インライン編集
      inlineEditId: null,
      inlineEditField: null,
      inlineEditValue: '',

      // カレンダー
      calendarTargetDate: new Date().toISOString().split('T')[0],
      calendarProjectId: '',

      // テンプレート
      templates: INITIAL_DATA.templates || [],
      editingTemplate: null,
      deletingTemplate: null,
      templateTab: 'edit',

      // 案件
      projects: INITIAL_DATA.projects || [],
      editingProject: null,
      deletingProject: null,

      // メンバー
      members: INITIAL_DATA.members || [],
      editingMember: null,
      deletingMember: null,

      // 配布
      distributingMemo: null,
      distributeMemberIds: [],

      // 設定
      settingsForm: {
        triggerHour: '7',
        targetCalendarIds: ['primary'],
        defaultTemplateId: '',
        baseFolderId: '',
        baseFolderUrl: ''
      },
      triggerStatus: { active: false, hour: '7' },
      availableCalendars: []
    };
  },

  computed: {
    // フィルタ・検索済み議事録
    filteredMemos: function() {
      var self = this;
      var list = this.memos;

      // ステータスフィルタ
      if (this.memoFilter !== 'all') {
        list = list.filter(function(m) { return m.status === self.memoFilter; });
      }

      // 案件フィルタ
      if (this.memoProjectFilter !== 'all') {
        list = list.filter(function(m) {
          return (m.projectId || '') === self.memoProjectFilter;
        });
      }

      // 日付範囲フィルタ
      if (this.memoDateFrom) {
        list = list.filter(function(m) {
          return (m.date || '') >= self.memoDateFrom;
        });
      }
      if (this.memoDateTo) {
        list = list.filter(function(m) {
          return (m.date || '') <= self.memoDateTo;
        });
      }

      // テキスト検索
      if (this.memoSearch) {
        var q = this.memoSearch.toLowerCase();
        list = list.filter(function(m) {
          return (m.title || '').toLowerCase().indexOf(q) !== -1 ||
                 (m.attendees || '').toLowerCase().indexOf(q) !== -1 ||
                 (m.content || '').toLowerCase().indexOf(q) !== -1;
        });
      }

      // 日付降順ソート
      list.sort(function(a, b) {
        return (b.date || '').localeCompare(a.date || '') ||
               (b.startTime || '').localeCompare(a.startTime || '');
      });

      return list;
    },

    // 全選択状態
    isAllSelected: function() {
      return this.filteredMemos.length > 0 &&
             this.selectedMemoIds.length === this.filteredMemos.length;
    },

    // アクティブな案件のみ
    activeProjects: function() {
      return this.projects.filter(function(p) {
        return p.status === 'active' || p.status === '';
      });
    },

    // フィルタ済み案件
    filteredProjects: function() {
      return this.projects;
    }
  },

  mounted: function() {
    if (this.setupDone) {
      this.applySettings_(INITIAL_DATA.settings);
      this.loadTriggerStatus();
    }
  },

  methods: {
    // === ナビゲーション ===
    navigate: function(page) {
      this.currentPage = page;
      this.sidebarOpen = false;
      if (page === 'settings') {
        this.loadCalendars();
        this.loadTriggerStatus();
      }
    },

    // === トースト通知 ===
    showToast: function(message, type) {
      this.toast = { message: message, type: type || 'success' };
      var el = this.$refs.toastEl;
      if (el) {
        var bsToast = new bootstrap.Toast(el, { delay: 3000 });
        bsToast.show();
      }
    },

    // === ローディング ===
    showLoading: function(msg) {
      this.loading = true;
      this.loadingMessage = msg || '処理中...';
    },
    hideLoading: function() {
      this.loading = false;
    },

    // === 初回セットアップ ===
    loadSetupFolders: function() {
      var self = this;
      gasRun('getDriveFolders')
        .then(function(folders) { self.setupFolders = folders || []; })
        .catch(function() {});
    },
    runSetup: function() {
      var self = this;
      this.setupRunning = true;
      gasRun('runSetup', this.setupFolderId || null)
        .then(function(result) {
          if (result.success) {
            self.setupDone = true;
            self.showToast('セットアップが完了しました');
            self.refreshMemos();
            self.refreshTemplates();
            self.refreshProjects();
            self.refreshMembers();
          } else {
            self.showToast(result.message, 'danger');
          }
        })
        .catch(function(err) {
          self.showToast('エラー: ' + err.message, 'danger');
        })
        .finally(function() {
          self.setupRunning = false;
        });
    },

    // === ヘルパー ===
    getProjectName: function(projectId) {
      if (!projectId) return '';
      var p = this.projects.find(function(p) { return p.id === projectId; });
      return p ? p.name : '';
    },
    getProjectMemberCount: function(project) {
      try {
        var ids = JSON.parse(project.memberIds || '[]');
        return ids.length;
      } catch (e) {
        return 0;
      }
    },

    // === 議事録一覧 ===
    refreshMemos: function() {
      var self = this;
      gasRun('getMemos')
        .then(function(data) { self.memos = data || []; })
        .catch(function(err) { self.showToast('取得失敗: ' + err.message, 'danger'); });
    },

    // === 議事録 選択 ===
    toggleSelect: function(id) {
      var idx = this.selectedMemoIds.indexOf(id);
      if (idx === -1) {
        this.selectedMemoIds.push(id);
      } else {
        this.selectedMemoIds.splice(idx, 1);
      }
    },
    toggleSelectAll: function() {
      if (this.isAllSelected) {
        this.selectedMemoIds = [];
      } else {
        this.selectedMemoIds = this.filteredMemos.map(function(m) { return m.id; });
      }
    },

    // === 議事録 作成・編集 ===
    openNewMemo: function() {
      this.editingMemo = {
        id: '',
        title: '',
        projectId: '',
        date: new Date().toISOString().split('T')[0],
        startTime: '',
        endTime: '',
        attendees: '',
        meetingLink: '',
        templateId: '',
        content: '',
        status: 'draft',
        docUrl: ''
      };
      this.currentPage = 'memo-edit';
    },

    editMemo: function(memo) {
      this.editingMemo = JSON.parse(JSON.stringify(memo));
      this.currentPage = 'memo-edit';
    },

    cancelEdit: function() {
      this.editingMemo = {};
      this.currentPage = 'memos';
    },

    saveMemo: function() {
      var self = this;
      this.showLoading('保存中...');
      var data = this.editingMemo;
      var promise;

      if (data.id) {
        promise = gasRun('updateMemo', data.id, data);
      } else {
        promise = gasRun('createMemo', data);
      }

      promise
        .then(function(result) {
          if (result.success) {
            self.showToast('保存しました');
            self.refreshMemos();
            self.currentPage = 'memos';
          } else {
            self.showToast(result.message, 'danger');
          }
        })
        .catch(function(err) { self.showToast('エラー: ' + err.message, 'danger'); })
        .finally(function() { self.hideLoading(); });
    },

    // === Googleドキュメント作成 ===
    createDocFromMemo: function() {
      var self = this;
      this.showLoading('ドキュメント作成中...');
      gasRun('createDocumentFromMemo', this.editingMemo.id, this.editingMemo.projectId)
        .then(function(result) {
          if (result.success) {
            self.editingMemo.docUrl = result.docUrl;
            self.showToast(result.message);
            self.refreshMemos();
          } else {
            self.showToast(result.message, 'danger');
          }
        })
        .catch(function(err) { self.showToast('エラー: ' + err.message, 'danger'); })
        .finally(function() { self.hideLoading(); });
    },

    // === テンプレート適用 ===
    applyTemplate: function() {
      var templateId = this.editingMemo.templateId;
      if (!templateId) return;
      var tmpl = this.templates.find(function(t) { return t.id === templateId; });
      if (tmpl && this.editingMemo.content === '') {
        var content = tmpl.body || '';
        var map = {
          '{{会議タイトル}}': this.editingMemo.title || '',
          '{{日付}}': this.editingMemo.date || '',
          '{{開始時刻}}': this.editingMemo.startTime || '',
          '{{終了時刻}}': this.editingMemo.endTime || '',
          '{{参加者}}': this.editingMemo.attendees || '',
          '{{会議リンク}}': this.editingMemo.meetingLink || '',
          '{{説明}}': ''
        };
        Object.keys(map).forEach(function(key) {
          content = content.split(key).join(map[key]);
        });
        this.editingMemo.content = content;
      }
    },

    // === インライン編集 ===
    startInlineEdit: function(memo, field) {
      this.inlineEditId = memo.id;
      this.inlineEditField = field;
      this.inlineEditValue = memo[field] || '';
    },
    saveInlineEdit: function(memo) {
      var self = this;
      var updateData = {};
      updateData[this.inlineEditField] = this.inlineEditValue;
      gasRun('updateMemo', memo.id, updateData)
        .then(function(result) {
          if (result.success) {
            memo[self.inlineEditField] = self.inlineEditValue;
            self.showToast('更新しました');
          }
        })
        .catch(function(err) { self.showToast('エラー: ' + err.message, 'danger'); })
        .finally(function() { self.cancelInlineEdit(); });
    },
    cancelInlineEdit: function() {
      this.inlineEditId = null;
      this.inlineEditField = null;
      this.inlineEditValue = '';
    },

    // === クイックステータス変更 ===
    quickStatusChange: function(memo, newStatus) {
      var self = this;
      gasRun('updateMemo', memo.id, { status: newStatus })
        .then(function(result) {
          if (result.success) {
            memo.status = newStatus;
            self.showToast('ステータスを変更しました');
          }
        })
        .catch(function(err) { self.showToast('エラー: ' + err.message, 'danger'); });
    },

    // === 削除 ===
    confirmDeleteMemo: function(memo) {
      this.deletingMemo = memo;
      new bootstrap.Modal(document.getElementById('deleteConfirmModal')).show();
    },
    doDeleteMemo: function() {
      var self = this;
      var id = this.deletingMemo.id;
      bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal')).hide();
      gasRun('bulkDeleteMemos', [id])
        .then(function(result) {
          if (result.success) {
            self.memos = self.memos.filter(function(m) { return m.id !== id; });
            self.showToast('削除しました');
          }
        })
        .catch(function(err) { self.showToast('エラー: ' + err.message, 'danger'); });
    },

    // === 一括操作 ===
    bulkStatus: function(status) {
      var self = this;
      this.showLoading('更新中...');
      gasRun('bulkUpdateMemoStatus', this.selectedMemoIds, status)
        .then(function(result) {
          if (result.success) {
            self.selectedMemoIds.forEach(function(id) {
              var m = self.memos.find(function(m) { return m.id === id; });
              if (m) m.status = status;
            });
            self.selectedMemoIds = [];
            self.showToast('一括更新しました');
          }
        })
        .catch(function(err) { self.showToast('エラー: ' + err.message, 'danger'); })
        .finally(function() { self.hideLoading(); });
    },
    bulkDelete: function() {
      var self = this;
      if (!confirm(this.selectedMemoIds.length + '件を削除しますか？')) return;
      this.showLoading('削除中...');
      gasRun('bulkDeleteMemos', this.selectedMemoIds)
        .then(function(result) {
          if (result.success) {
            var ids = self.selectedMemoIds;
            self.memos = self.memos.filter(function(m) { return ids.indexOf(m.id) === -1; });
            self.selectedMemoIds = [];
            self.showToast('削除しました');
          }
        })
        .catch(function(err) { self.showToast('エラー: ' + err.message, 'danger'); })
        .finally(function() { self.hideLoading(); });
    },

    // === カレンダーから取得 ===
    fetchFromCalendar: function() {
      new bootstrap.Modal(document.getElementById('calendarModal')).show();
    },
    doFetchFromCalendar: function() {
      var self = this;
      bootstrap.Modal.getInstance(document.getElementById('calendarModal')).hide();
      this.showLoading('カレンダーからイベントを取得中...');
      gasRun('generateMemosFromCalendar', this.calendarTargetDate, this.calendarProjectId || null)
        .then(function(result) {
          if (result.success) {
            self.showToast(result.message);
            self.refreshMemos();
          } else {
            self.showToast(result.message, 'danger');
          }
        })
        .catch(function(err) { self.showToast('エラー: ' + err.message, 'danger'); })
        .finally(function() { self.hideLoading(); });
    },

    // === 配布 ===
    openDistributeModal: function(memo) {
      this.distributingMemo = memo;
      // 案件メンバーがあればデフォルト選択
      this.distributeMemberIds = [];
      if (memo.projectId) {
        var project = this.projects.find(function(p) { return p.id === memo.projectId; });
        if (project && project.memberIds) {
          try {
            this.distributeMemberIds = JSON.parse(project.memberIds);
          } catch (e) {}
        }
      }
      new bootstrap.Modal(document.getElementById('distributeModal')).show();
    },
    doDistributeEmail: function() {
      var self = this;
      bootstrap.Modal.getInstance(document.getElementById('distributeModal')).hide();
      this.showLoading('メール送信中...');
      gasRun('distributeMemoByEmail', this.distributingMemo.id, this.distributeMemberIds)
        .then(function(result) {
          self.showToast(result.message, result.success ? 'success' : 'danger');
        })
        .catch(function(err) { self.showToast('エラー: ' + err.message, 'danger'); })
        .finally(function() { self.hideLoading(); });
    },
    doDistributeChat: function() {
      var self = this;
      bootstrap.Modal.getInstance(document.getElementById('distributeModal')).hide();
      this.showLoading('Chat送信中...');
      gasRun('distributeMemoByChat', this.distributingMemo.id, this.distributeMemberIds)
        .then(function(result) {
          self.showToast(result.message, result.success ? 'success' : 'danger');
        })
        .catch(function(err) { self.showToast('エラー: ' + err.message, 'danger'); })
        .finally(function() { self.hideLoading(); });
    },

    // === テンプレート管理 ===
    refreshTemplates: function() {
      var self = this;
      gasRun('getTemplates')
        .then(function(data) { self.templates = data || []; })
        .catch(function(err) { self.showToast('取得失敗: ' + err.message, 'danger'); });
    },
    openNewTemplate: function() {
      this.editingTemplate = {
        id: '',
        name: '',
        body: '',
        docId: '',
        docUrl: '',
        isDefault: false
      };
      this.templateTab = 'edit';
    },
    selectTemplate: function(t) {
      this.editingTemplate = JSON.parse(JSON.stringify(t));
      this.templateTab = 'edit';
    },
    saveTemplate: function() {
      var self = this;
      this.showLoading('保存中...');
      var data = this.editingTemplate;
      var promise;
      if (data.id) {
        promise = gasRun('updateTemplate', data.id, data);
      } else {
        promise = gasRun('createTemplate', data);
      }
      promise
        .then(function(result) {
          if (result.success) {
            self.showToast('テンプレートを保存しました');
            self.refreshTemplates();
            self.editingTemplate = null;
          } else {
            self.showToast(result.message, 'danger');
          }
        })
        .catch(function(err) { self.showToast('エラー: ' + err.message, 'danger'); })
        .finally(function() { self.hideLoading(); });
    },
    confirmDeleteTemplate: function(t) {
      this.deletingTemplate = t;
      new bootstrap.Modal(document.getElementById('deleteTemplateModal')).show();
    },
    doDeleteTemplate: function() {
      var self = this;
      var id = this.deletingTemplate.id;
      bootstrap.Modal.getInstance(document.getElementById('deleteTemplateModal')).hide();
      gasRun('deleteTemplate', id)
        .then(function(result) {
          if (result.success) {
            self.refreshTemplates();
            if (self.editingTemplate && self.editingTemplate.id === id) {
              self.editingTemplate = null;
            }
            self.showToast('テンプレートを削除しました');
          }
        })
        .catch(function(err) { self.showToast('エラー: ' + err.message, 'danger'); });
    },

    // === 案件管理 ===
    refreshProjects: function() {
      var self = this;
      gasRun('getProjects')
        .then(function(data) { self.projects = data || []; })
        .catch(function(err) { self.showToast('取得失敗: ' + err.message, 'danger'); });
    },
    openNewProject: function() {
      this.editingProject = {
        id: '',
        name: '',
        description: '',
        folderId: '',
        folderUrl: '',
        status: 'active',
        selectedMemberIds: []
      };
    },
    selectProject: function(p) {
      var proj = JSON.parse(JSON.stringify(p));
      try {
        proj.selectedMemberIds = JSON.parse(proj.memberIds || '[]');
      } catch (e) {
        proj.selectedMemberIds = [];
      }
      this.editingProject = proj;
    },
    saveProject: function() {
      var self = this;
      this.showLoading('保存中...');
      var data = this.editingProject;
      data.memberIds = data.selectedMemberIds || [];
      var promise;
      if (data.id) {
        promise = gasRun('updateProject', data.id, data);
      } else {
        promise = gasRun('createProject', data);
      }
      promise
        .then(function(result) {
          if (result.success) {
            self.showToast('案件を保存しました');
            self.refreshProjects();
            self.editingProject = null;
          } else {
            self.showToast(result.message, 'danger');
          }
        })
        .catch(function(err) { self.showToast('エラー: ' + err.message, 'danger'); })
        .finally(function() { self.hideLoading(); });
    },
    confirmDeleteProject: function(p) {
      this.deletingProject = p;
      new bootstrap.Modal(document.getElementById('deleteProjectModal')).show();
    },
    doDeleteProject: function() {
      var self = this;
      var id = this.deletingProject.id;
      bootstrap.Modal.getInstance(document.getElementById('deleteProjectModal')).hide();
      gasRun('deleteProject', id)
        .then(function(result) {
          if (result.success) {
            self.refreshProjects();
            if (self.editingProject && self.editingProject.id === id) {
              self.editingProject = null;
            }
            self.showToast('案件を削除しました');
          }
        })
        .catch(function(err) { self.showToast('エラー: ' + err.message, 'danger'); });
    },

    // === メンバー管理 ===
    refreshMembers: function() {
      var self = this;
      gasRun('getMembers')
        .then(function(data) { self.members = data || []; })
        .catch(function(err) { self.showToast('取得失敗: ' + err.message, 'danger'); });
    },
    openNewMember: function() {
      this.editingMember = {
        id: '',
        name: '',
        email: '',
        chatWebhookUrl: ''
      };
    },
    selectMember: function(m) {
      this.editingMember = JSON.parse(JSON.stringify(m));
    },
    saveMember: function() {
      var self = this;
      this.showLoading('保存中...');
      var data = this.editingMember;
      var promise;
      if (data.id) {
        promise = gasRun('updateMember', data.id, data);
      } else {
        promise = gasRun('createMember', data);
      }
      promise
        .then(function(result) {
          if (result.success) {
            self.showToast('メンバーを保存しました');
            self.refreshMembers();
            self.editingMember = null;
          } else {
            self.showToast(result.message, 'danger');
          }
        })
        .catch(function(err) { self.showToast('エラー: ' + err.message, 'danger'); })
        .finally(function() { self.hideLoading(); });
    },
    confirmDeleteMember: function(m) {
      this.deletingMember = m;
      new bootstrap.Modal(document.getElementById('deleteMemberModal')).show();
    },
    doDeleteMember: function() {
      var self = this;
      var id = this.deletingMember.id;
      bootstrap.Modal.getInstance(document.getElementById('deleteMemberModal')).hide();
      gasRun('deleteMember', id)
        .then(function(result) {
          if (result.success) {
            self.refreshMembers();
            if (self.editingMember && self.editingMember.id === id) {
              self.editingMember = null;
            }
            self.showToast('メンバーを削除しました');
          }
        })
        .catch(function(err) { self.showToast('エラー: ' + err.message, 'danger'); });
    },

    // === 設定 ===
    applySettings_: function(settings) {
      if (!settings) return;
      this.settingsForm.triggerHour = settings.triggerHour || '7';
      this.settingsForm.defaultTemplateId = settings.defaultTemplateId || '';
      this.settingsForm.baseFolderId = settings.baseFolderId || '';
      this.settingsForm.baseFolderUrl = settings.baseFolderUrl || '';
      try {
        var calIds = JSON.parse(settings.targetCalendarIds || '["primary"]');
        this.settingsForm.targetCalendarIds = calIds;
      } catch (e) {
        this.settingsForm.targetCalendarIds = ['primary'];
      }
    },

    loadCalendars: function() {
      var self = this;
      gasRun('getUserCalendars')
        .then(function(cals) { self.availableCalendars = cals || []; })
        .catch(function() {});
    },

    loadTriggerStatus: function() {
      var self = this;
      gasRun('getTriggerStatus')
        .then(function(status) { self.triggerStatus = status; })
        .catch(function() {});
    },

    saveAllSettings: function() {
      var self = this;
      this.showLoading('設定を保存中...');
      var data = {
        triggerHour: this.settingsForm.triggerHour,
        targetCalendarIds: JSON.stringify(this.settingsForm.targetCalendarIds),
        defaultTemplateId: this.settingsForm.defaultTemplateId
      };
      gasRun('saveSettings', data)
        .then(function(result) {
          if (result.success) {
            self.showToast('設定を保存しました');
          } else {
            self.showToast(result.message, 'danger');
          }
        })
        .catch(function(err) { self.showToast('エラー: ' + err.message, 'danger'); })
        .finally(function() { self.hideLoading(); });
    },

    saveTrigger: function() {
      var self = this;
      this.showLoading('トリガーを設定中...');
      gasRun('setupDailyTrigger', parseInt(this.settingsForm.triggerHour))
        .then(function(result) {
          self.showToast(result.message, result.success ? 'success' : 'danger');
          self.loadTriggerStatus();
        })
        .catch(function(err) { self.showToast('エラー: ' + err.message, 'danger'); })
        .finally(function() { self.hideLoading(); });
    },

    removeTrigger: function() {
      var self = this;
      gasRun('removeDailyTrigger')
        .then(function(result) {
          self.showToast(result.message);
          self.loadTriggerStatus();
        })
        .catch(function(err) { self.showToast('エラー: ' + err.message, 'danger'); });
    },

    confirmReset: function() {
      new bootstrap.Modal(document.getElementById('resetConfirmModal')).show();
    },
    doReset: function() {
      var self = this;
      bootstrap.Modal.getInstance(document.getElementById('resetConfirmModal')).hide();
      gasRun('resetSetup')
        .then(function(result) {
          if (result.success) {
            self.setupDone = false;
            self.memos = [];
            self.templates = [];
            self.projects = [];
            self.members = [];
            self.showToast(result.message);
          }
        })
        .catch(function(err) { self.showToast('エラー: ' + err.message, 'danger'); });
    }
  }
});

app.mount('#app');
</script>
