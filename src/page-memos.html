<!-- 議事録一覧画面 -->
<div class="page-header">
  <h2><i class="bi bi-list-check me-2"></i>議事録一覧</h2>
</div>

<!-- アクションバー -->
<div class="action-bar">
  <button class="btn btn-primary" @click="openNewMemo">
    <i class="bi bi-plus-lg me-1"></i>新規作成
  </button>
  <button class="btn btn-outline-secondary" @click="fetchFromCalendar">
    <i class="bi bi-calendar-event me-1"></i>カレンダーから取得
  </button>
  <button class="btn btn-outline-secondary" @click="refreshMemos">
    <i class="bi bi-arrow-clockwise me-1"></i>更新
  </button>

  <!-- 一括操作（選択時表示） -->
  <template v-if="selectedMemoIds.length > 0">
    <span class="text-muted ms-2">{{ selectedMemoIds.length }}件選択</span>
    <div class="btn-group ms-1">
      <button class="btn btn-sm btn-outline-success" @click="bulkStatus('completed')">完了</button>
      <button class="btn btn-sm btn-outline-warning" @click="bulkStatus('draft')">下書き</button>
      <button class="btn btn-sm btn-outline-danger" @click="bulkDelete">削除</button>
    </div>
  </template>

  <!-- フィルタ・検索（右寄せ） -->
  <div class="ms-auto d-flex gap-2 flex-wrap">
    <!-- 案件フィルタ -->
    <select class="form-select form-select-sm" v-model="memoProjectFilter" style="width:auto;min-width:120px">
      <option value="all">全案件</option>
      <option value="">未分類</option>
      <option v-for="p in projects" :key="p.id" :value="p.id">{{ p.name }}</option>
    </select>
    <!-- ステータスフィルタ -->
    <select class="form-select form-select-sm" v-model="memoFilter" style="width:auto">
      <option value="all">すべて</option>
      <option value="draft">下書き</option>
      <option value="completed">完了</option>
      <option value="archived">アーカイブ</option>
    </select>
    <!-- 日付範囲フィルタ -->
    <input type="date" class="form-control form-control-sm" v-model="memoDateFrom"
           style="width:auto" placeholder="開始日" title="開始日">
    <span class="align-self-center text-muted">〜</span>
    <input type="date" class="form-control form-control-sm" v-model="memoDateTo"
           style="width:auto" placeholder="終了日" title="終了日">
    <!-- テキスト検索 -->
    <div class="input-group input-group-sm search-bar">
      <span class="input-group-text"><i class="bi bi-search"></i></span>
      <input type="text" class="form-control" placeholder="検索..." v-model="memoSearch">
    </div>
  </div>
</div>

<!-- 一覧テーブル -->
<div class="card">
  <div class="table-responsive">
    <table class="table table-hover mb-0">
      <thead>
        <tr>
          <th style="width:30px">
            <input type="checkbox" class="form-check-input"
                   :checked="isAllSelected" @change="toggleSelectAll">
          </th>
          <th>タイトル</th>
          <th style="width:100px">案件</th>
          <th style="width:100px">日付</th>
          <th style="width:90px">時間</th>
          <th style="width:80px">ステータス</th>
          <th style="width:140px">操作</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="memo in filteredMemos" :key="memo.id"
            :class="{ 'table-row-selected': selectedMemoIds.includes(memo.id) }">
          <td @click.stop>
            <input type="checkbox" class="form-check-input"
                   :checked="selectedMemoIds.includes(memo.id)"
                   @change="toggleSelect(memo.id)">
          </td>
          <td>
            <template v-if="inlineEditId === memo.id">
              <input class="inline-edit-input" v-model="inlineEditValue"
                     @keyup.enter="saveInlineEdit(memo)" @keyup.escape="cancelInlineEdit">
            </template>
            <template v-else>
              <span @dblclick="startInlineEdit(memo, 'title')" style="cursor:pointer">
                {{ memo.title || '（無題）' }}
              </span>
              <a v-if="memo.docUrl" :href="memo.docUrl" target="_blank"
                 class="ms-1" style="color:var(--primary);font-size:0.75rem" title="Googleドキュメントを開く">
                <i class="bi bi-file-earmark-text"></i>
              </a>
            </template>
          </td>
          <td>
            <span class="chip" v-if="getProjectName(memo.projectId)">
              {{ getProjectName(memo.projectId) }}
            </span>
            <span v-else class="text-muted" style="font-size:0.75rem">-</span>
          </td>
          <td style="font-size:0.8rem">{{ memo.date }}</td>
          <td style="font-size:0.8rem">{{ memo.startTime }}{{ memo.endTime ? '-' + memo.endTime : '' }}</td>
          <td>
            <select class="form-select form-select-sm py-0" style="font-size:0.75rem"
                    :value="memo.status" @change="quickStatusChange(memo, $event.target.value)">
              <option value="draft">下書き</option>
              <option value="completed">完了</option>
              <option value="archived">アーカイブ</option>
            </select>
          </td>
          <td>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary" @click="editMemo(memo)" title="編集">
                <i class="bi bi-pencil-square"></i>
              </button>
              <button class="btn btn-outline-success" @click="openDistributeModal(memo)" title="配布">
                <i class="bi bi-send"></i>
              </button>
              <button class="btn btn-outline-danger" @click="confirmDeleteMemo(memo)" title="削除">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </td>
        </tr>
        <tr v-if="filteredMemos.length === 0">
          <td colspan="7" class="empty-state">
            <i class="bi bi-inbox d-block"></i>
            議事録がありません
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- 削除確認モーダル -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title">削除確認</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        「{{ deletingMemo?.title || '（無題）' }}」を削除しますか？
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">キャンセル</button>
        <button type="button" class="btn btn-sm btn-danger" @click="doDeleteMemo">削除</button>
      </div>
    </div>
  </div>
</div>

<!-- カレンダー取得モーダル -->
<div class="modal fade" id="calendarModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title"><i class="bi bi-calendar-event me-2"></i>カレンダーから議事メモを生成</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">対象日</label>
          <input type="date" class="form-control" v-model="calendarTargetDate">
        </div>
        <div class="mb-3">
          <label class="form-label">案件（任意）</label>
          <select class="form-select" v-model="calendarProjectId">
            <option value="">未分類</option>
            <option v-for="p in activeProjects" :key="p.id" :value="p.id">{{ p.name }}</option>
          </select>
          <small class="text-muted">案件を指定するとGoogleドキュメントも自動作成されます</small>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
        <button type="button" class="btn btn-primary" @click="doFetchFromCalendar">
          <i class="bi bi-download me-1"></i>生成
        </button>
      </div>
    </div>
  </div>
</div>

<!-- 配布モーダル -->
<div class="modal fade" id="distributeModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title"><i class="bi bi-send me-2"></i>議事録を配布</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p class="mb-3">「{{ distributingMemo?.title || '（無題）' }}」を配布します。</p>
        <h6 class="mb-2">配布先メンバー</h6>
        <div v-for="m in members" :key="m.id" class="form-check mb-1">
          <input class="form-check-input" type="checkbox" :id="'dist-' + m.id"
                 :value="m.id" v-model="distributeMemberIds">
          <label class="form-check-label" :for="'dist-' + m.id">
            <span class="member-avatar me-1" style="width:24px;height:24px;font-size:0.6rem">
              {{ (m.name || '?').charAt(0) }}
            </span>
            {{ m.name }} <small class="text-muted">{{ m.email }}</small>
          </label>
        </div>
        <div v-if="members.length === 0" class="text-muted">
          メンバーが登録されていません
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
        <button type="button" class="btn btn-primary" @click="doDistributeEmail"
                :disabled="distributeMemberIds.length === 0">
          <i class="bi bi-envelope me-1"></i>メールで送信
        </button>
        <button type="button" class="btn btn-success" @click="doDistributeChat"
                :disabled="distributeMemberIds.length === 0">
          <i class="bi bi-chat-dots me-1"></i>Chatで送信
        </button>
      </div>
    </div>
  </div>
</div>
